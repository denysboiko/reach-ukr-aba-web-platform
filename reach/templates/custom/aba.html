{% extends "base.html" %}
{% load staticfiles %}


{% block libs %}
    <script src='{% static 'js/mapbox-gl.js' %}'></script>
    <link href='{% static 'css/mapbox-gl.css' %}' rel='stylesheet' />

    <link rel="stylesheet" type="text/css" href='{% static 'css/selectize/selectize.min.css' %}' />
    <link rel="stylesheet" type="text/css" href='{% static 'css/selectize/selectize.default.min.css' %}' />


    <script src='{% static 'js/mapbox-gl-geocoder.js' %}'></script>
    <link rel='stylesheet' href='{% static 'css/mapbox-gl-geocoder.css' %}' type='text/css' />

    <script src='{% static 'js/mapbox-gl-draw.js' %}'></script>
    <link rel='stylesheet' href='{% static 'css/mapbox-gl-draw.css' %}' type='text/css'/>


{% endblock libs %}


{% block content %}




    <div class="wrappers" style="width:20%; overflow:auto">
        <!-- Sidebar -->
        <div class="filters" style="height: 100%; overflow: auto;">

            <div class="filter">
                <label>Layers:</label>
                <nav id="menu"></nav>
            </div>

            <div class="filter">
                <button type="button" id="reset" class="btn btn-secondary">Reset Filters</button>
                <button type="button" id="modal-toggle" class="btn btn-primary" data-toggle="modal" data-target="#myModal">
                    Enter data
                </button>
            </div>

        </div>
    </div>
    <div class="wrappers" style="width:80%">
        <div id='map-container'></div>
    <div id='sectors-legend' class='legend'>
        <h6>Sectors</h6>
    </div>
    </div>



    <!-- Modal -->
    <div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">

            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="exampleModalLabel">Enter data</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <form method="post" action="">{% csrf_token %}
                    <div class="modal-body">

                        {{ form }}

                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                        <button type="submit" class="btn btn-primary" id="save">Save</button>
                    </div>
                </form>

            </div>
        </div>
    </div>

{% endblock content %}


{% block libs2 %}

    <script src="{% static 'js/d3.min.js' %}"></script>
    <script src="{% static 'js/crossfilter.v1.min.js' %}"></script>
    <script src='{% static 'js/selectize.min.js' %}'></script>

    <script src="{% static 'js/d3-queue.v3.min.js' %}"></script>

    <script src="{% static 'js/map-points.js' %}"></script>
    <script src="{% static 'js/filters.js' %}"></script>

    <script>

        d3.queue()
          .defer(d3.json, "{% static 'data/aba/services.geojson' %}")
          .defer(d3.json, "{% static 'data/aba/5km_buffer.geojson' %}")
          .defer(d3.json, "{% static 'data/aba/community_areas.geojson' %}")
          .defer(d3.json, "{% static 'data/aba/5km_settlements.geojson' %}")
          .await(loadData);

        function loadData(error, data, buffer, community_areas, settlements) {

            MapInit(data, buffer, community_areas, settlements);

            var featureCount = data.features.length;
            var cf = crossfilter(data.features);

            var oblast = cf.dimension(function(d) { return d.properties['ADMIN_1_EN']; });
            var type = cf.dimension(function(d) { return d.properties['Type']; });
            var settlement = cf.dimension(function(d) { return d.properties['ADMIN4_EN']; });
            var sector = cf.dimension(function(d) { return d.properties['Sector']; });


        {#        $('#reset').on('click', function(){#}
        {#            resetSettlement();#}
        {#        });#}



            var filtersList = [
                {id: 'oblasts',
                 dimension: oblast,
                 label: 'Oblasts'},
                {id: 'settlements',
                 dimension: settlement,
                 label: 'Settlements'},
                {id: 'sectors',
                 dimension: sector,
                 label: 'Sector'},
                {id: 'types',
                 dimension: type,
                 label: 'Types'}
            ];

            var sectors = [
                ['Bank', '#fbb03b'],
                ['Post', '#223b53'],
                ['Health', '#e55e5e'],
                ['Government', '#9b59b6'],
                ['Education', '#8bc34a'],
                ['Transport', '#bdc3c7'],
                ['Market', '#3bb2d0']
            ];


{#            <div>#}
{#                <span style='background-color: #723122'></span>25,000,000#}
{#            </div>#}

            var legend = d3.select(".legend")
                .selectAll(".legend")
                .data(sectors)
                .enter()
                .append("div");

            legend.append("span")
                .attr('style', function (d) {
                    return "background-color: " + d[1];
                }).attr('class', 'marker');

            legend.append("span").text(function (d) {
                    return d[0];
                });


            filerContainers(filtersList);

            for (var i = 0; i < filtersList.length; i++) {
                var filter = filtersList[i];
                var container = '#' + filter.id;
                createFilter(container, filter.dimension)
            }

        }

    </script>

<script>

    $('#modal-toggle').on('click', function(){
        var data = draw.getAll();
        $('#id_polygon').val(JSON.stringify(data, null, 2));
    });

</script>

{% endblock libs2 %}